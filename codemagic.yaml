workflows:
  ios_release:
    name: iOS Release (Pods repo-update)
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        LC_ALL: en_US.UTF-8
        LANG: en_US.UTF-8
    scripts:
      - name: Pre-build: Prepare plugins and install pods
        script: |
          set -e
          echo "[CI] Cleaning CocoaPods caches and previous lock/Pods"
          rm -rf ~/Library/Caches/CocoaPods
          rm -rf ~/Library/Developer/Xcode/DerivedData
          rm -rf ios/Pods
          rm -f ios/Podfile.lock
          echo "[CI] Running flutter pub get to regenerate .symlinks"
          flutter pub get
          echo "[CI] Bumping plugin podspec platform requirements to iOS 15.0"
          if [ -d .symlinks/plugins ]; then
            find .symlinks/plugins -name "*.podspec" -print0 | xargs -0 sed -i '' "s/platform :ios, '12.0'/platform :ios, '15.0'/g"
            find .symlinks/plugins -name "*.podspec" -print0 | xargs -0 sed -i '' "s/platform :ios, '13.0'/platform :ios, '15.0'/g"
            find .symlinks/plugins -name "*.podspec" -print0 | xargs -0 sed -i '' "s/platform :ios, '14.0'/platform :ios, '15.0'/g"
            # Also handle s.platform assignment style within podspecs
            find .symlinks/plugins -name "*.podspec" -print0 | xargs -0 sed -i '' -E "s/(s\.platform = :ios, ')[0-9]+\.[0-9]+'/\115.0'/g"
            find .symlinks/plugins -name "*.podspec" -print0 | xargs -0 sed -i '' -E "s/(spec\.platform = :ios, ')[0-9]+\.[0-9]+'/\115.0'/g"
          fi
          echo "[CI] Installing pods (repo update)"
          cd ios
          pod install --repo-update
          cd ..
      - name: Flutter build iOS (no codesign)
        script: |
          flutter clean
          flutter pub get
          flutter build ipa --release --no-codesign
    artifacts:
      - build/ios/ipa/*.ipa
      - build/**/xcarchive.zip
    cache:
      cache_paths:
        - ~/.pub-cache
        - ios/Pods
        - ~/Library/Caches/CocoaPods
  ios_appstore_signed:
    name: iOS App Store Signed
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        LC_ALL: en_US.UTF-8
        LANG: en_US.UTF-8
        CLICKPAY_PROFILE_ID: "45213"
        CLICKPAY_SERVER_KEY: "SBJNLZMHZG-JJND2BM6JR-6H96BWMMBJ"
        CLICKPAY_CLIENT_KEY: "CPKMD6-D67G66-QDM2NG-GPG7MH"
        APPLE_MERCHANT_ID: "merchant.com.meshaal.meshaalcenter"
        MERCHANT_DISPLAY_NAME: "Meshaal Center"
        COUNTRY_CODE: "SA"
        CURRENCY_CODE: "SAR"
      groups:
        - app_store_connect
        - signing
    scripts:
      - name: Generate clickpay_credentials.dart from env
        script: |
          set -e
          cat > lib/core/payment/clickpay_credentials.dart <<EOF
          // Auto-generated from CI environment variables
          class ClickPayCredentials {
            static const String profileId = "$CLICKPAY_PROFILE_ID";
            static const String serverKey = "$CLICKPAY_SERVER_KEY";
            static const String clientKey = "$CLICKPAY_CLIENT_KEY";
            static const String appleMerchantId = "$APPLE_MERCHANT_ID";
            static const String merchantDisplayName = "$MERCHANT_DISPLAY_NAME";
            static const String countryCode = "$COUNTRY_CODE";
            static const String currencyCode = "$CURRENCY_CODE";
            static bool isTestMode = false;
          }
          EOF
          echo "[CI] Generated clickpay_credentials.dart"
      - name: Pre-build: Prepare & install pods (signed)
        script: |
          set -e
          flutter pub get
          cd ios
          rm -f Podfile.lock
          pod install --repo-update
          cd ..
      - name: Set build number from pubspec
        script: |
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | cut -d'+' -f2)
          echo "Detected build number: $BUILD_NUMBER"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ios/Runner/Info.plist
      - name: Build signed IPA
        script: |
          set -e
          if [ ! -f ios/exportOptions.plist ]; then
            echo "[CI][ERROR] Missing ios/exportOptions.plist" >&2
            ls -R ios | head -n 50 || true
            exit 1
          fi
          flutter build ipa --release --export-options-plist=ios/exportOptions.plist
      - name: Show archive logs if fail (helper)
        script: |
          set +e
          if [ ! -d build/ios/archive ]; then
            echo "[CI] Archive folder missing; listing build logs for diagnostics." || true
            find build -name '*.log' -maxdepth 4 -print -exec tail -n 40 {} \; || true
          fi
    artifacts:
      - build/ios/ipa/*.ipa
      - build/ios/archive/*.xcarchive
    publishing:
      app_store_connect:
        ipa_path: build/ios/ipa/*.ipa
        submit_to_testflight: true
        submit_to_review: false
